<!DOCTYPE html>
<html>
<head>
    <title>VR Optical Fiber Lab</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <style>
        /* Hide the A-Frame boilerplate cursor */
        .a-touch-controls-canvas { display: none; }
    </style>
</head>
<body>

<script>
    // --- 1. Fiber Logic Component (Stores data and performs calculations) ---
    AFRAME.registerComponent('fiber-logic', {
        schema: {
            length: {type: 'number', default: 1000}, // Initial length in meters
            naValue: {type: 'number', default: 0.22}, // Target NA
            alphaValue: {type: 'number', default: 0.3}, // Target Alpha (dB/km)
            coupledPower: {type: 'number', default: 100}, // Base coupled power (µW)
            isAligned: {type: 'boolean', default: false}
        },

        init: function () {
            this.el.sceneEl.setAttribute('data-store', {
                P_long_uW: 0,
                L_long_m: this.data.length,
                P_short_uW: 0,
                L_short_m: 2, // Cut-back length
                NA_r_m: 0,
                NA_D_m: 0.2, // Screen distance (20 cm)
                alpha_result: 'N/A',
                na_result: 'N/A'
            });
            this.dataStore = this.el.sceneEl.getAttribute('data-store');
            this.resultsPanel = document.querySelector('#results-panel');
        },

        calculateNA: function (r_m) {
            // NA = sin(arctan(r/D))
            const NA_result = Math.sin(Math.atan(r_m / this.dataStore.NA_D_m)).toFixed(3);
            this.dataStore.na_result = NA_result;
            this.updateResultsPanel();
        },

        calculateAlpha: function () {
            if (this.dataStore.P_long_uW > 0 && this.dataStore.P_short_uW > 0) {
                const P_long_dBm = 10 * Math.log10(this.dataStore.P_long_uW / 1000);
                const P_short_dBm = 10 * Math.log10(this.dataStore.P_short_uW / 1000);
                
                // Alpha (dB/km) = 10 / (L_long - L_short) * log10(P_short / P_long)
                // Using dBm: Alpha (dB/km) = (P_short_dBm - P_long_dBm) / (L_long_km - L_short_km)
                const L_diff_km = (this.dataStore.L_long_m - this.dataStore.L_short_m) / 1000;
                
                let alpha_result = (P_short_dBm - P_long_dBm) / L_diff_km;
                
                // Check for successful measurement (should be positive value for a short cut-back)
                if (alpha_result > 0) {
                     this.dataStore.alpha_result = alpha_result.toFixed(2);
                } else {
                     this.dataStore.alpha_result = 'Error (P_short < P_long)';
                }
            } else {
                this.dataStore.alpha_result = 'Missing Power Readings';
            }
            this.updateResultsPanel();
        },

        updateResultsPanel: function() {
            const text = `
                NA: ${this.dataStore.na_result}
                Attenuation: ${this.dataStore.alpha_result} dB/km
                --- Data ---
                L_long: ${this.dataStore.L_long_m} m
                P_long: ${this.dataStore.P_long_uW.toFixed(1)} uW
                L_short: ${this.dataStore.L_short_m} m
                P_short: ${this.dataStore.P_short_uW.toFixed(1)} uW
            `;
            this.resultsPanel.setAttribute('text', { value: text.trim() });
        }
    });

    // --- 2. Power Meter Component (Simulates real-time reading) ---
    AFRAME.registerComponent('power-meter-display', {
        schema: {
            connected: {type: 'boolean', default: false},
            mode: {type: 'string', default: 'NA'}, // NA or ALPHA
        },

        init: function () {
            this.powerMeterUI = document.querySelector('#power-meter-ui');
            this.fiberLogic = document.querySelector('#fiber-dut').components['fiber-logic'];
            this.isLongFiber = true;
        },

        tick: function() {
            if (!this.data.connected) {
                this.powerMeterUI.setAttribute('text', { value: 'Power: --.--- dBm\nNOT CONNECTED' });
                return;
            }

            const L = this.isLongFiber ? this.fiberLogic.dataStore.L_long_m : this.fiberLogic.dataStore.L_short_m;
            const alpha = this.fiberLogic.data.alphaValue;
            const P0 = this.fiberLogic.data.coupledPower;

            // Simple attenuation model: P(L) = P0 * 10^(-alpha*L_km / 10)
            const P_uW = P0 * Math.pow(10, (-alpha * (L / 1000)) / 10);
            const P_dBm = 10 * Math.log10(P_uW / 1000);

            this.powerMeterUI.setAttribute('text', { value: `Power: ${P_dBm.toFixed(3)} dBm\n (${P_uW.toFixed(1)} µW)` });

            // Store the stable reading for the calculation step
            if (this.isLongFiber) {
                this.fiberLogic.dataStore.P_long_uW = P_uW;
            } else {
                this.fiberLogic.dataStore.P_short_uW = P_uW;
            }
        }
    });

    // --- 3. Interactive Cleaver Component (Simulates Cut-Back) ---
    AFRAME.registerComponent('interactable-cleaver', {
        init: function () {
            this.el.setAttribute('clickable', ''); // Use A-Frame extras clicker for interaction
            this.el.addEventListener('click', this.doCutback.bind(this));
            this.fiberEnd = document.querySelector('#fiber-end-2');
            this.fiberLogic = document.querySelector('#fiber-dut').components['fiber-logic'];
            this.detector = document.querySelector('#photodetector').components['power-meter-display'];
        },

        doCutback: function() {
            if (this.detector.isLongFiber) {
                // 1. Record P_long
                this.fiberLogic.dataStore.P_long_uW = this.fiberLogic.dataStore.P_long_uW;
                
                // 2. Perform Cut-Back
                this.detector.isLongFiber = false;
                
                // 3. Move the fiber end closer (visually and logically to L_short)
                this.fiberEnd.object3D.position.set(0, 0.8, -2.5); // Move to the short fiber position
                document.querySelector('#fiber-dut').setAttribute('line', 'end: 0 0.8 -2.5');

                console.log('Cut-back successful. Switched to short fiber mode.');
                this.fiberLogic.updateResultsPanel();
            } else {
                // Already cut, now calculate Alpha
                this.fiberLogic.calculateAlpha();
            }
        }
    });

    // --- 4. Alignment Knob Component (Simulates coupling alignment) ---
    AFRAME.registerComponent('alignment-knob', {
        schema: {
            axis: {type: 'string'}, // x, y, or z
            alignmentFactor: {type: 'number', default: 0},
            targetNA: {type: 'selector'} // The NA screen
        },
        init: function() {
            this.el.setAttribute('clickable', '');
            this.el.addEventListener('click', this.align.bind(this));
            this.isAligned = false;
        },
        align: function() {
            // Simple alignment: each click moves closer to perfect alignment
            this.data.alignmentFactor = Math.min(1.0, this.data.alignmentFactor + 0.25);
            
            if (this.data.alignmentFactor >= 1.0 && !this.isAligned) {
                this.isAligned = true;
                // Once aligned, enable calculation and simulate the optimal light spot (NA r)
                
                // Simulate optimal spot radius for NA (e.g., 5cm)
                const optimal_r_m = 0.05; 
                this.fiberLogic = document.querySelector('#fiber-dut').components['fiber-logic'];
                this.fiberLogic.calculateNA(optimal_r_m); 

                // Visually update the NA screen spot size
                this.data.targetNA.setAttribute('material', 'src: #spot-texture; repeat: 0 0'); // Remove the big alignment spot
                this.data.targetNA.setAttribute('geometry', 'primitive: circle; radius: 0.05'); // Show the measured spot
                this.data.targetNA.setAttribute('text', 'value: Spot Radius (r):\n5 cm; align: center; wrapCount: 15');
                console.log('Fiber is perfectly aligned. NA spot measurement ready.');
            }
        }
    });

    // --- 5. Scene Data Store Component (Placeholder for global data) ---
    AFRAME.registerComponent('data-store', {
        schema: {
            P_long_uW: {type: 'number', default: 0},
            L_long_m: {type: 'number', default: 1000},
            P_short_uW: {type: 'number', default: 0},
            L_short_m: {type: 'number', default: 2},
            NA_r_m: {type: 'number', default: 0},
            NA_D_m: {type: 'number', default: 0.2},
            alpha_result: {type: 'string', default: 'N/A'},
            na_result: {type: 'string', default: 'N/A'}
        }
    });

</script>


<a-scene background="color: #444">

    <!-- Assets (Simulated Textures for Visuals) -->
    <a-assets>
        <img id="spot-texture" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAAD/u5/..." crossorigin="anonymous">
        <img id="lab-texture" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJwAAABACAYAAAD/u5/..." crossorigin="anonymous">
    </a-assets>

    <!-- 1. Environment and Lighting -->
    <a-entity light="type: ambient; color: #BBB; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.7" position="-1 1 1"></a-entity>
    
    <!-- Optical Bench -->
    <a-box position="0 0.6 -2" scale="4 0.1 1.5" material="color: #111; roughness: 0.1; metalness: 0.9"></a-box>

    <!-- User Camera and Controllers (Hands) -->
    <a-entity movement-controls="speed: 0.5" position="0 1.6 0">
        <a-camera></a-camera>
        <!-- Use basic geometry for hands/controllers for simplicity -->
        <a-entity laser-controls="hand: left" line="opacity: 0.5" raycaster="objects: [clickable]"></a-entity>
        <a-entity laser-controls="hand: right" line="opacity: 0.5" raycaster="objects: [clickable]"></a-entity>
    </a-entity>

    <!-- 2. Equipment Setup -->

    <!-- A. Light Source & Coupler Stage -->
    <a-box position="-1.5 0.7 -2.5" scale="0.3 0.2 0.3" material="color: #666" text="value: Fiber Source; align: center; wrapCount: 15; width: 0.3"></a-box>
    
    <!-- Alignment Knobs -->
    <a-cylinder id="x-knob" position="-1.5 0.9 -2.3" radius="0.03" height="0.1" material="color: gold" 
        alignment-knob="axis: x; target: #na-screen" clickable></a-cylinder>
    <a-cylinder id="y-knob" position="-1.3 0.9 -2.5" radius="0.03" height="0.1" material="color: gold" 
        alignment-knob="axis: y; target: #na-screen" clickable></a-cylinder>
    <a-text value="ALIGN" position="-1.4 1.0 -2.4" width="0.5" color="#FF0000"></a-text>

    <!-- B. Optical Fiber (DUT) -->
    <a-entity id="fiber-dut" fiber-logic="length: 1000; naValue: 0.22; alphaValue: 0.3">
        <!-- The line entity represents the long fiber -->
        <a-entity id="fiber-line" line="start: -1.3 0.7 -2.5; end: 1.8 0.7 -2.5; color: gray; opacity: 0.8" 
                  geometry="primitive: cylinder; radius: 0.005; height: 3.1" rotation="0 90 0" position="0.25 0.7 -2.5">
        </a-entity>
    </a-entity>
    
    <!-- Fiber End (Detector side) -->
    <a-sphere id="fiber-end-2" position="1.8 0.7 -2.5" radius="0.015" material="color: red; emissive: red" 
              clickable></a-sphere>

    <!-- C. Photodetector and Rail -->
    <a-box id="photodetector" position="1.8 0.7 -2.5" scale="0.1 0.2 0.2" material="color: #4a4a4a" 
           power-meter-display="connected: true" text="value: PHOTODETECTOR; width: 0.5; wrapCount: 10"></a-box>

    <!-- D. NA Measurement Screen (Starts in NA mode) -->
    <a-plane id="na-screen" position="1.8 0.9 -2.1" rotation="0 0 0" width="0.4" height="0.4"
             material="color: white; opacity: 1.0"
             text="value: NA SPOT TEST\nClick the GOLD knobs to align.\nDistance D = 20 cm; color: black; align: center; wrapCount: 20">
             <!-- Initial simulated light spot for visual feedback -->
             <a-circle position="0 0 0.001" radius="0.15" material="color: red; opacity: 0.5"></a-circle>
    </a-plane>


    <!-- 3. UI/Display Elements -->

    <!-- Virtual Power Meter Display (Readout for P_long and P_short) -->
    <a-plane id="power-meter-ui" position="2.2 1.3 -2.5" rotation="0 -30 0" width="0.6" height="0.3"
             material="color: #000; opacity: 0.8"
             text="value: Power: --.--- dBm\nNOT CONNECTED; color: #00FF00; align: left; wrapCount: 15"></a-plane>

    <!-- Calculation UI/Results Panel -->
    <a-plane id="results-panel" position="0 1.5 -0.5" width="1.0" height="0.8"
             material="color: #333; opacity: 0.9"
             text="value: NA: N/A\nAttenuation: N/A dB/km\n(Click CLEAVE to start Alpha calc); color: white; wrapCount: 30"></a-plane>

    <!-- 4. Interactive Tools -->
    <a-box id="fiber-cleaver" geometry="primitive: box; height: 0.1; width: 0.2; depth: 0.1" 
           material="color: silver" position="0.5 0.8 -1.5"
           interactable-cleaver clickable 
           text="value: CLEAVE FIBER\n(Alpha Calc); align: center; width: 0.2; wrapCount: 10"></a-box>

</a-scene>
</body>
</html>
